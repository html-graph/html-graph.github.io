<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>HTMLGraph | Minimal Custom Edge Shape demo</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <style>
      html,
      body {
        height: 100%;
        padding: 0;
        margin: 0;
      }

      body {
        position: relative;
        font-family: Arial, sans-serif;
      }

      #canvas {
        position: absolute;
        inset: 0;
      }

      .node {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100px;
        height: 100px;
        background: #daedbd;
        border: 1px solid #9e9e9e;
        box-shadow: 0 0 5px #9e9e9e;
        border-radius: 50%;
        user-select: none;
      }

      .node-port {
        position: relative;
        width: 0;
      }

      .node-port::after {
        content: "";
        position: absolute;
        top: -3px;
        left: -3px;
        width: 6px;
        height: 6px;
        background: #777777;
        border-radius: 3px;
      }

      .custom-line {
        filter: drop-shadow(3px 3px 2px #FF0000);
      }
    </style>
  </head>
  <body>
    <div id="canvas"></div>
    <script type="module">
      import { CanvasBuilder } from "https://unpkg.com/@html-graph/html-graph@7.3.0";

      class MyCustomEdgeShape {
        constructor() {
          this.svg = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "svg",
          );

          this.svg.style.pointerEvents = "none";
          this.svg.style.position = "absolute";
          this.svg.style.top = "0";
          this.svg.style.left = "0";
          this.svg.style.overflow = "visible";

          this.line = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "path",
          );
          this.line.setAttribute("stroke", "#777777");
          this.line.setAttribute("stroke-width", "1");
          this.line.setAttribute("fill", "none");
          this.line.classList.add("custom-line");

          this.svg.appendChild(this.line);
        }

        render(params) {
          const { from, to } = params;

          const centerFrom = {
            x: from.x + from.width / 2,
            y: from.y + from.height / 2,
          };

          const centerTo = {
            x: to.x + to.width / 2,
            y: to.y + to.height / 2,
          };

          const x = Math.min(centerFrom.x, centerTo.x);
          const y = Math.min(centerFrom.y, centerTo.y);
          const width = Math.abs(centerTo.x - centerFrom.x);
          const height = Math.abs(centerTo.y - centerFrom.y);

          this.svg.style.width = `${width}px`;
          this.svg.style.height = `${height}px`;
          this.svg.style.transform = `translate(${x}px, ${y}px)`;

          const centerX = width / 2;
          const centerY = height / 2;
          const flipX = centerFrom.x <= centerTo.x ? 1 : -1;
          const flipY = centerFrom.y <= centerTo.y ? 1 : -1;

          const fromX = centerX - centerX * flipX;
          const fromY = centerY - centerY * flipY;
          const toX = centerX + centerX * flipX;
          const toY = centerY + centerY * flipY;

          const linePath = `M ${fromX} ${fromY} L ${toX} ${toY}`;

          this.line.setAttribute("d", linePath);
        }
      }

      class Application {
        constructor(element) {
          this.canvas = new CanvasBuilder(element)
            .setDefaults({
              edges: {
                shape: () => {
                  return new MyCustomEdgeShape();
                }
              }
            })
            .enableUserDraggableNodes()
            .enableUserTransformableViewport()
            .enableBackground()
            .build();
        }

        initGraph() {
          this.canvas
            .addNode(
              this.createNode({
                name: "Node 1",
                x: 200,
                y: 200,
                frontPortId: "node-1-in",
                backPortId: "node-1-out",
              }),
            )
            .addNode(
              this.createNode({
                name: "Node 2",
                x: 600,
                y: 300,
                frontPortId: "node-2-in",
                backPortId: "node-2-out",
              }),
            )
            .addEdge({
              id: "1",
              from: "node-1-out",
              to: "node-2-in",
            });
        }

        createNode({ name, x, y, frontPortId, backPortId }) {
          const node = document.createElement("div");
          const text = document.createElement("div");
          const frontPort = document.createElement("div");
          const backPort = document.createElement("div");

          node.classList.add("node");
          frontPort.classList.add("node-port");
          backPort.classList.add("node-port");
          text.innerText = name;

          node.appendChild(frontPort);
          node.appendChild(text);
          node.appendChild(backPort);

          return {
            element: node,
            x: x,
            y: y,
            ports: [
              { id: frontPortId, element: frontPort },
              { id: backPortId, element: backPort },
            ],
          };
        }
      }

      const element = document.getElementById("canvas");
      const app = new Application(element);

      app.initGraph();
    </script>
  </body>
</html>
