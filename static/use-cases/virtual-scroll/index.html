<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>HTMLGraph | Virtual scroll demo</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <style>
      html,
      body {
        height: 100%;
        padding: 0;
        margin: 0;
      }

      body {
        position: relative;
        font-family: Arial, sans-serif;
      }

      button {
        cursor: pointer;
        padding: 1rem;
      }

      #canvas {
        position: absolute;
        inset: 0;
      }

      .overlay {
        z-index: 1;
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: #ffffffaa;
      }

      .node {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100px;
        height: 100px;
        background: #daedbd;
        border: 1px solid #9e9e9e;
        box-shadow: 0 0 5px #9e9e9e;
        border-radius: 50%;
        user-select: none;
      }

      .node-port {
        position: relative;
        width: 0;
      }

      .node-port::after {
        content: "";
        position: absolute;
        top: -3px;
        left: -3px;
        width: 6px;
        height: 6px;
        background: #777777;
        border-radius: 3px;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid green;
        border-radius: 50%;
        border-bottom-color: transparent;
        animation: rotation 1s linear infinite;
        display: none;
      }

      .status {
        margin-top: 1rem;
      }

      @keyframes rotation {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div id="overlay" class="overlay">
      <div id="spinner" class="spinner"></div>
      <div id="status" class="status"></div>
      <button id="load-button">
        <h2>Load 100 000 nodes</h2>
      </button>
    </div>
    <div id="canvas"></div>
    <script type="module">
      import { CanvasBuilder } from "https://unpkg.com/@html-graph/html-graph@7.4.0";

      class Application {
        status = document.getElementById("status");

        constructor(element) {
          this.canvas = new CanvasBuilder(element)
            .setDefaults({
              edges: {
                shape: {
                  type: "horizontal",
                  hasTargetArrow: true,
                },
              },
            })
            .enableUserTransformableViewport({
              transformPreprocessor: {
                type: "scale-limit",
                minContentScale: 0.3,
              },
            })
            .enableVirtualScroll({
              nodeContainingRadius: {
                horizontal: 25,
                vertical: 25,
              },
            })
            .enableBackground()
            .build();

        }

        async initGraph() {
          let prevPortId = null;

          const total = 100_000;
          const layer = total / 10;
          const collection = Array.from({ length: total }).map((_, i) => i);

          const iterator = collection.values();
          let current = iterator.next();
          let processedTotal = 0;

          while (!current.done) {
            await this.executeMacrotask(() => {
              let processed = 0;

              while (!current.done && processed < 1000) {
                const iter = current.value;
                const frontPortId = `node-${iter}-in`;
                const backPortId = `node-${iter}-out`;

                const i = iter % layer;
                const j = Math.floor(iter / layer);

                const request = this.createNode({
                  name: `Node ${iter}`,
                  x: i * 300,
                  y: j * 300,
                  frontPortId,
                  backPortId,
                });

                this.canvas.addNode(request);

                if (prevPortId !== null) {
                  this.canvas.addEdge({ from: prevPortId, to: frontPortId });
                }

                prevPortId = backPortId;
                current = iterator.next();
                processed++;
              }

              processedTotal += processed;

              const percent = (processedTotal / total) * 100;

              this.status.innerText = `${Math.floor(percent)}%`;
            });
          }
        }

        createNode({ name, x, y, frontPortId, backPortId }) {
          const node = document.createElement("div");
          const text = document.createElement("div");
          const frontPort = document.createElement("div");
          const backPort = document.createElement("div");

          node.classList.add("node");
          frontPort.classList.add("node-port");
          backPort.classList.add("node-port");
          text.innerText = name;

          node.appendChild(frontPort);
          node.appendChild(text);
          node.appendChild(backPort);

          return {
            element: node,
            x: x,
            y: y,
            ports: [
              { id: frontPortId, element: frontPort },
              { id: backPortId, element: backPort },
            ],
          };
        }

        executeMacrotask(task) {
          return new Promise((resolve) => {
            setTimeout(() => {
              task();
              resolve();
            });
          });
        };
      }

      const btn = document.getElementById("load-button");
      const overlay = document.getElementById("overlay");
      const spinner = document.getElementById("spinner");

      btn.addEventListener("click", () => {
        btn.style.display = "none";
        spinner.style.display = "block";

        setTimeout(async () => {
          const element = document.getElementById("canvas");
          const app = new Application(element);

          await app.initGraph();
          overlay.style.display = "none";
        });
      });
    </script>
  </body>
</html>
